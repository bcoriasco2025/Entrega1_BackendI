<h1 class="mb-4 text-center">Mi Carrito</h1>

{{#if cart.products.length}}
  <div class="row">
    {{#each cart.products}}
      <div class="col-md-4 mb-3">
        <div class="card h-100">
          <img
            src="{{this.product.thumbnails.[0]}}"
            class="card-img-top"
            alt="{{this.product.title}}"
          >
          <div class="card-body text-center">
            <h5 class="card-title">{{this.product.title}}</h5>
            <p>{{this.product.description}}</p>
            <p><strong>Precio:</strong> ${{this.product.price}}</p>
            <p>
              <strong>Cantidad:</strong>
              <input
                type="number"
                min="1"
                value="{{this.quantity}}"
                id="qty-{{this.product._id}}"
                class="form-control form-control-sm d-inline-block w-50"
              >
            </p>
            <p>
              <strong>Subtotal:</strong>
              ${{multiply this.product.price this.quantity}}
            </p>

            <div class="d-flex justify-content-center gap-2 mt-2">
              
              <button class="btn btn-danger btn-sm" onclick="removeProduct('{{../cart._id}}','{{this.product._id}}')">
                Eliminar
              </button>

            </div>
          </div>
        </div>
      </div>
    {{/each}}
  </div>

  <div class="mt-4 text-center">
    <button class="btn btn-warning" onclick="clearCart('{{cart._id}}')">
      Vaciar Carrito
    </button>
  </div>

{{else}}
  <p class="text-center">El carrito está vacío</p>
{{/if}}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const cartId = "{{cart._id}}";


  async function removeProduct(cartId, productId) {
    try {
      const res = await fetch(`/api/carts/${cartId}/products/${productId}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.status === 'success') {
        Swal.fire('Producto eliminado', '', 'success').then(() => location.reload());
      } else {
        Swal.fire('Error', data.message, 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'No se pudo eliminar el producto', 'error');
    }
  }

  async function updateQuantity(cartId, productId) {
    const qty = document.getElementById(`qty-${productId}`).value;
    try {
      const res = await fetch(`/api/carts/${cartId}/products/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: parseInt(qty) })
      });
      const data = await res.json();
      if (data.status === 'success') {
        Swal.fire('Cantidad actualizada', '', 'success').then(() => location.reload());
      } else {
        Swal.fire('Error', data.message, 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'No se pudo actualizar la cantidad', 'error');
    }
  }

  async function clearCart(cartId) {
    try {
      const res = await fetch(`/api/carts/${cartId}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.status === 'success') {
        Swal.fire('Carrito vaciado', '', 'success').then(() => location.reload());
      } else {
        Swal.fire('Error', data.message, 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'No se pudo vaciar el carrito', 'error');
    }
  }

  async function updateCart(cartId, products) {
    try {
      const res = await fetch(`/api/carts/${cartId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ products })
      });
      const data = await res.json();
      if (data.status === 'success') {
        Swal.fire('Carrito actualizado', '', 'success').then(() => location.reload());
      } else {
        Swal.fire('Error', data.message, 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'No se pudo actualizar el carrito', 'error');
    }
  }
</script>
